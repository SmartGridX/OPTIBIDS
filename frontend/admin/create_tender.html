<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Tender â€” OPTIBOTS</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
</head>
<body>

<div class="dash-layout">
  <!-- SIDEBAR -->
  <aside class="dash-sidebar">
    <div class="dash-sidebar-logo">OPTIBOTS</div>
    <ul class="dash-nav">
      <li><a href="admin_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span>Dashboard</a></li>
      <li><a href="create_tender.html" class="active"><span class="nav-icon"><i class="fas fa-plus-circle"></i></span>Create Tender</a></li>
      <li><a href="admin_accepted.html"><span class="nav-icon"><i class="fas fa-handshake"></i></span>Accepted Offers</a></li>
      <div class="nav-separator"></div>
      <li class="logout"><button onclick="doLogout()"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>Logout</button></li>
    </ul>
  </aside>

  <!-- MAIN -->
  <main class="dash-main">
    <div class="dash-header">
      <h1>Create New Tender</h1>
      <p>Publish a new RFP for vendors to discover and apply.</p>
    </div>

    <div class="form-container">
      <div class="form-card">

        <div id="create-error" class="error-msg"></div>
        <div id="create-success" class="error-msg" style="background:rgba(52,211,153,0.1);border-color:rgba(52,211,153,0.3);color:var(--accent-green);"></div>

        <div class="form-row">
          <label for="t-title"><i class="fas fa-heading" style="margin-right:.4rem;"></i>Tender Title</label>
          <input id="t-title" class="auth-input form-input" type="text" placeholder="e.g. Supply of Office Furniture Q3 2025" />
        </div>

        <div class="form-row">
          <label for="t-desc"><i class="fas fa-align-left" style="margin-right:.4rem;"></i>Tender Description</label>
          <textarea id="t-desc" class="auth-input form-input" placeholder="Describe the requirements in detail. Be specific about quantities, specifications, timelines, and evaluation criteria. The AI will use this text to extract requirements and match SKUs."></textarea>
        </div>

        <div class="form-row">
          <label><i class="fas fa-paperclip" style="margin-right:.4rem;"></i>Attachment <span style="color:var(--text-3);font-weight:400;">(optional)</span></label>
          <div class="file-upload-area" id="file-drop-zone">
            <input id="t-file" type="file" accept=".pdf,.doc,.docx,.txt" onchange="updateFileName(this)" />
            <i class="fas fa-cloud-upload-alt"></i>
            <p><strong>Click to upload</strong> or drag & drop</p>
            <p style="font-size:0.78rem;margin-top:.25rem;">PDF, DOC, DOCX, TXT supported</p>
            <p id="file-name-display" style="margin-top:.5rem;font-size:0.82rem;color:var(--primary-light);display:none;"></p>
          </div>
        </div>

        <div style="display:flex;gap:1rem;margin-top:1.5rem;">
          <button id="publish-btn" class="auth-btn primary" style="flex:1;" onclick="publishTender()">
            <i class="fas fa-bullhorn"></i> Publish Tender
          </button>
          <a href="admin_dashboard.html" class="auth-btn" style="flex:1;text-align:center;">
            <i class="fas fa-times"></i> Cancel
          </a>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="toast-container"></div>

<script src="../js/api.js"></script>
<script src="../js/utils.js"></script>
<script>

function doLogout() {
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}

function updateFileName(input) {
  const display = document.getElementById('file-name-display');
  if (input.files[0]) {
    display.textContent = 'ðŸ“Ž ' + input.files[0].name;
    display.style.display = 'block';
  }
}

async function publishTender() {
  const title = document.getElementById('t-title').value.trim();
  const desc  = document.getElementById('t-desc').value.trim();
  const file  = document.getElementById('t-file').files[0];
  const errEl = document.getElementById('create-error');
  const okEl  = document.getElementById('create-success');
  const btn   = document.getElementById('publish-btn');

  errEl.classList.remove('show');
  okEl.classList.remove('show');

  if (!title || !desc) {
    errEl.textContent = 'Title and description are required.';
    errEl.classList.add('show');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishingâ€¦';

  try {
    const form = new FormData();
    form.append('title', title);
    form.append('description', desc);
    form.append('published', 'true');
    if (file) form.append('file', file);

    await api.upload('/admin/tenders', form);

    okEl.textContent = 'âœ… Tender published successfully! Redirectingâ€¦';
    okEl.classList.add('show');

    setTimeout(() => { window.location.href = '/admin/admin_dashboard.html'; }, 1500);
  } catch (err) {
    errEl.textContent = 'Failed to publish tender. Please try again.';
    errEl.classList.add('show');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-bullhorn"></i> Publish Tender';
  }
}

// Auth guard
(async () => {
  try {
    const user = await api.get('/auth/me');
    if (!user || user.role !== 'admin') window.location.href = '/login.html';
  } catch { window.location.href = '/login.html'; }
})();
</script>

</body>
</html>
