<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Applicant Dashboard — OPTIBOTS</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
</head>
<body>

<div class="dash-layout">
  <!-- SIDEBAR -->
  <aside class="dash-sidebar">
    <div class="dash-sidebar-logo">OPTIBOTS</div>
    <ul class="dash-nav">
      <li><a href="applicant_dashboard.html" class="active"><span class="nav-icon"><i class="fas fa-th-large"></i></span>Dashboard</a></li>
      <li><a href="applicant_accepted.html"><span class="nav-icon"><i class="fas fa-file-signature"></i></span>My Contracts</a></li>
      <div class="nav-separator"></div>
      <li class="logout"><button onclick="doLogout()"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>Logout</button></li>
    </ul>
  </aside>

  <!-- MAIN -->
  <main class="dash-main">
    <div class="dash-header flex-between">
      <div>
        <h1>Applicant Dashboard</h1>
        <p>Browse active tenders, submit proposals, and manage offers.</p>
      </div>
      <div style="position:relative;">
        <button class="auth-btn" id="notif-btn" onclick="toggleNotifPanel()" style="position:relative;">
          <i class="fas fa-bell"></i> Notifications
          <span id="notif-badge" style="display:none;position:absolute;top:-6px;right:-6px;background:var(--accent-amber);color:#000;font-size:0.7rem;font-weight:800;border-radius:99px;padding:.1rem .4rem;"></span>
        </button>
      </div>
    </div>

    <!-- NOTIFICATIONS PANEL (hidden by default) -->
    <div id="notif-panel" class="section-card" style="display:none;border-color:rgba(251,191,36,0.3);background:rgba(251,191,36,0.04);">
      <div class="section-card-header">
        <h2><i class="fas fa-bell" style="color:var(--accent-amber);"></i> Pending Offers</h2>
        <button class="btn-icon" onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
      </div>
      <div id="notifications" class="card-list">
        <div class="loading-state"><div class="spinner"></div><p>Loading offers…</p></div>
      </div>
    </div>

    <!-- AVAILABLE TENDERS -->
    <div class="section-card">
      <div class="section-card-header">
        <h2><i class="fas fa-file-contract"></i> Available Tenders</h2>
        <button class="btn-icon" onclick="applicant.loadTenders()" title="Refresh"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div id="public-tenders" class="card-list">
        <div class="loading-state"><div class="spinner"></div><p>Loading tenders…</p></div>
      </div>
    </div>

  </main>
</div>

<!-- APPLY MODAL -->
<div class="modal-overlay" id="apply-modal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-paper-plane" style="color:var(--primary-light);margin-right:.5rem;"></i>Submit Proposal</h3>
      <button class="modal-close" onclick="closeApplyModal()"><i class="fas fa-times"></i></button>
    </div>

    <input id="apply-tender-id" type="hidden" />

    <p style="font-size:0.85rem;color:var(--text-2);margin-bottom:1.25rem;">
      Describe your proposal clearly. Include pricing, SKU availability, timeline, and relevant experience.
      The AI system will evaluate your submission.
    </p>

    <div id="tender-name-display" style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:.75rem 1rem;margin-bottom:1rem;font-size:0.88rem;color:var(--primary-light);font-weight:600;"></div>

    <div class="form-row">
      <label for="apply-text">Your Proposal</label>
      <textarea id="apply-text" class="auth-input form-input"
        placeholder="We propose to supply the requested items at the following specifications and pricing…"
        style="min-height:160px;"></textarea>
    </div>

    <div style="display:flex;gap:.75rem;margin-top:.5rem;">
      <button class="auth-btn primary" style="flex:1;" id="apply-submit-btn" onclick="submitProposal()">
        <i class="fas fa-paper-plane"></i> Submit Proposal
      </button>
      <button class="auth-btn" onclick="closeApplyModal()">Cancel</button>
    </div>

    <p id="apply-msg" style="margin-top:.75rem;font-size:0.82rem;text-align:center;"></p>
  </div>
</div>

<div id="toast-container"></div>

<script src="../js/api.js"></script>
<script src="../js/utils.js"></script>
<script src="../js/applicant.js"></script>
<script>
function doLogout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

let notifOpen = false;
function toggleNotifPanel() {
  notifOpen = !notifOpen;
  document.getElementById('notif-panel').style.display = notifOpen ? 'block' : 'none';
  if (notifOpen) applicant.loadNotifications();
}

// closeApplyModal — hides the proposal modal
function closeApplyModal() {
  document.getElementById('apply-modal').classList.remove('open');
}

// submitProposal — posts to backend
async function submitProposal() {
  const tenderId = Number(document.getElementById('apply-tender-id').value);
  const text = document.getElementById('apply-text').value.trim();
  const btn = document.getElementById('apply-submit-btn');
  const msg = document.getElementById('apply-msg');

  if (!text) { showToast('Please write your proposal first', 'error'); return; }

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting…';

  try {
    const res = await api.post('/applicant/submit_application', { tender_id: tenderId, text });
    msg.innerHTML = `<span style="color:var(--accent-green);"><i class="fas fa-check-circle"></i> Proposal submitted! (ID #${res.application_id})</span>`;
    showToast('Proposal submitted successfully!', 'success');
    btn.innerHTML = '<i class="fas fa-check"></i> Submitted';
    setTimeout(closeApplyModal, 2000);
  } catch (e) {
    msg.innerHTML = `<span style="color:var(--accent-red);">Submission failed. You may have already applied.</span>`;
    showToast('Submission failed', 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Proposal';
  }
}

function showToast(msg, type='info') {
  const icons = { success:'fa-check-circle', error:'fa-times-circle', info:'fa-info-circle' };
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<i class="fas ${icons[type]}"></i><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// Close modal on backdrop click
document.getElementById('apply-modal').addEventListener('click', function(e) {
  if (e.target === this) closeApplyModal();
});

// Auth guard + load
(async () => {
  try {
    const user = await api.get('/auth/me');
    if (!user || user.role !== 'applicant') { window.location.href = '/login.html'; return; }
    applicant.loadTenders();
    // Check for pending offers silently
    try {
      const offers = await api.get('/applicant/notifications');
      if (offers.length) {
        const badge = document.getElementById('notif-badge');
        badge.style.display = 'block';
        badge.textContent = offers.length;
        showToast(`You have ${offers.length} pending offer(s)!`, 'info');
      }
    } catch {}
  } catch { window.location.href = '/login.html'; }
})();
</script>

</body>
</html>
